<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruby &middot; Moselog</title>

  <meta name="description" content="Various rants from Mose.">

  <meta name="generator" content="Hugo 0.15-DEV" />
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="mo5e" />
  <meta name="twitter:title" content="Ruby &middot; Moselog">
  <meta name="twitter:description" content="Various rants from Mose.">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Ruby &middot; Moselog">
  <meta property="og:description" content="Various rants from Mose.">

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
  <!--[if lte IE 8]>
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://log.mose.com/css/all.min.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="Moselog" href="http://log.mose.com/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
  <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    <hgroup>
      <h1 class="brand-title"><a href="http://log.mose.com">Moselog</a></h1>
      <h2 class="brand-tagline">Various rants from Mose.</h2>
    </hgroup>

    <nav class="nav">
      <ul class="nav-list">
        
        <li class="nav-item">
          <a class="pure-button" href="https://twitter.com/mo5e"><i class="fa fa-twitter"></i> Twitter</a>
        </li>
        
        
        <li class="nav-item">
          <a class="pure-button" href="https://github.com/mose "><i class="fa fa-github-alt"></i> github</a>
        </li>
        
        <li class="nav-item">
          <a class="pure-button" href="http://log.mose.com/index.xml"><i class="fa fa-rss"></i> rss</a>
        </li>
      </ul>
    </nav>
  </div>
  

</div>


  <div class="content pure-u-1 pure-u-md-3-4">
    <div>
      
      <div class="posts">
        
          <h1 class="content-subhead">
  2014-06-12
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/faria-devtips">faria devtips</a>
    
    
      <a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a><a class="post-tags post-tags-s3" href="http://log.mose.com/tags/s3">s3</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2014/06/12/s3-backups" class="post-title">S3 backups</a>
            </header>

            <div class="post-description">
              <p>We use S3 to backup various kind of files on MB. We use the very convenient backup gem for that (we still use 3.9.0).</p>

<ul>
<li><a href="http://meskyanichi.github.io/backup/v4/">http://meskyanichi.github.io/backup/v4/</a></li>
</ul>

<p>But at some point it appeared that backing up our audio recording was hammering disk IO on our server, because the syncer is calculating md5 footprint for each file each time a backup happens. When you get thousands of big files that is pretty expensive process (in our case 20k files and 50G total).</p>

<p>So I added a small trick there:</p>

<p>in <code>Backup/models/backup_audio.rb</code></p>

<pre><code class="language-ruby">module Backup::Syncer::Cloud
  class Base &lt; Syncer::Base
    def process_orphans
      if @orphans.is_a?(Queue)
        @orphans = @orphans.size.times.map { @orphans.shift }
      end
      &quot;Older Files: #{ @orphans.count }&quot;
    end
  end
end

Backup::Model.new(:backup_audio, 'Audio files Backup to S3') do

  before do
    system(&quot;/Backup/latest_audio.sh&quot;)
  end

  after do
    FileUtils.rm_rf(&quot;/tmp/streams&quot;)
  end

  ##
  # Amazon Simple Storage Service [Syncer]
  #
  sync_with Cloud::S3 do |s3|
    s3.access_key_id     = &quot;xxx&quot;
    s3.secret_access_key = &quot;xxx&quot;
    s3.bucket            = &quot;bucket_backup&quot;
    s3.region            = &quot;us-east-1&quot;
    s3.path              = &quot;/mb_audio_backup&quot;
    s3.mirror            = false
    s3.thread_count      = 50

    s3.directories do |directory|
      directory.add &quot;/tmp/streams&quot;
    end
  end
end
</code></pre>

<p>and in <code>Backup/latest_audio.sh</code></p>

<pre><code class="language-bash">#!/bin/sh
# isolate files changed in the last 3 days

TMPDIR=/tmp/streams

mkdir $TMPDIR
for i in `find /storage/audio/ -type f -cmin -4320`; do
  ln -s $i $TMPDIR
done
</code></pre>

<p>It creates a fake backup dir with links to the files that actually changed in the last 3 days and patches the syncer to avoid flooding the logs with orphan files. When sometimes S3 upload fails on one file (and it happens from time to time for &lsquo;amazonian&rsquo; reason) it will be caught on the next daily backup.</p>

<p>The result was pretty obvious on our disk usage with our daily backups:</p>

<img src="http://res.cloudinary.com/mosepix/image/upload/devtips/2014-06-12-s3backup.png" alt="graph" class="pure-img" />



<p>in the logs:</p>

<pre><code>[2014/06/10 07:00:25][info] Summary:
[2014/06/10 07:00:25][info]   Transferred Files: 5
[2014/06/10 07:00:25][info]   Older Files: 22371
[2014/06/10 07:00:25][info]   Unchanged Files: 16
[2014/06/10 07:00:25][info] Syncer::Cloud::S3 Finished!
[2014/06/10 07:00:25][info] Backup for 'Audio files Backup to S3 (backup_audio)' Completed Successfully in 00:00:22
[2014/06/10 07:00:25][info] After Hook Starting...
[2014/06/10 07:00:25][info] After Hook Finished.
</code></pre>

            </div>
          </section>
        
          <h1 class="content-subhead">
  2014-06-04
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/faria-devtips">faria devtips</a>
    
    
      <a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a><a class="post-tags post-tags-rubygems" href="http://log.mose.com/tags/rubygems">rubygems</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2014/06/04/make-a-gem" class="post-title">Make a gem</a>
            </header>

            <div class="post-description">
              

<p>Making and publishing your own gems is so incredibly simple. Here is my setp by step process when I want to publish one:</p>

<h2 id="make-a-rubygems-account:a6c8c79e924ce88903bef7ff7392e41e">Make a Rubygems account</h2>

<ul>
<li>first ensure create an ccount on <a href="https://rubygems.org/">https://rubygems.org/</a></li>
<li>initialize your credentials:</li>
</ul>

<pre><code>curl -u username https://rubygems.org/api/v1/api_key.yaml &gt; ~/.gem/credentials
Enter host password for user 'username':

chmod 0600 ~/.gem/credentials
</code></pre>

<h2 id="prepare-the-code:a6c8c79e924ce88903bef7ff7392e41e">Prepare the code</h2>

<p>These steps are my typical path, nothing is really mandatory there.</p>

<ul>
<li>create a repo at github (or wherever you want)</li>
<li>create a base gem skeleton <code>bundle gem mycoolgem</code></li>
<li>update the README.md, add some minimal information. The clearest you explain what it does the best chances people will adopt it. Add cypirght information</li>
<li>create a CHANGELOG.md because when you publish something you need a clear log of your version changes</li>
<li>enable the tracking on <a href="https://codeclimate.com/">codeclimate</a>, <a href="https://travis-ci.org/">travis</a>, <a href="https://coveralls.io/">coveralls</a>, <a href="https://gemnasium.com">gemnasium</a></li>
<li>add badges from <a href="http://shields.io">http://shields.io</a> in the README.md because it helps to qualify the state of the code quickly</li>
<li>when the gem code don&rsquo;t need to have access to the version number, I found convenient to just remove the version file and add version in the .gemspec from the changelog file with <code>spec.version  = File.read(File.expand_path('../CHANGELOG.md', __FILE__))[/([0-9]+\.[0-9]+\.[0-9]+)/]</code>
(so then when I version bump there is only one file to edit)</li>
<li>write the code (or copy it from the private app you extract it from)</li>
<li>add a spec/ or test/ dir and write some tests and try to reach a decent coverage</li>
</ul>

<h2 id="release-it:a6c8c79e924ce88903bef7ff7392e41e">Release it</h2>

<ul>
<li>add the date in the changelog for the current version</li>
<li><code>rake release</code></li>
<li>bump the version to the next increment in the changelog (and version file if any)</li>
</ul>

<p>Overall with the initial bundle command and the final rake task for release, it&rsquo;s pretty straightforward.</p>

<p>Also check <a href="http://guides.rubygems.org/make-your-own-gem/">http://guides.rubygems.org/make-your-own-gem/</a></p>

            </div>
          </section>
        
          <h1 class="content-subhead">
  2014-05-27
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/faria-devtips">faria devtips</a>
    
    
      <a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a><a class="post-tags post-tags-rubygems" href="http://log.mose.com/tags/rubygems">rubygems</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2014/05/27/gem-reverse-dependencies" class="post-title">Gem reverse dependencies</a>
            </header>

            <div class="post-description">
              <p>I have been looking for a way to see what gem uses a gem, so I can see examples of integration in other projects. The rubygems API guide don&rsquo;t tell anything about such reverse dependency query. But it is actually there, it got merged some time ago, and optimized, but it is not documented yet (it runs really fast, kudos Rubygems guys).</p>

<pre><code class="language-ruby">ruby -ropen-uri -rpp -ryaml \
     -e 'pp YAML.load(open(&quot;https://rubygems.org/api/v1/gems/rails_best_practices/reverse_dependencies.yaml&quot;))'

[&quot;metric_fu&quot;,
 &quot;flyerhzm-metric_fu&quot;,
 &quot;edouard-metric_fu&quot;,
 &quot;devver-metric_fu&quot;,
 &quot;goldstar-metric_fu&quot;,
 &quot;socializer&quot;,
 &quot;trollface&quot;,
 &quot;guard-rails_best_practices&quot;,
 &quot;rferraz-metric_fu&quot;,
 &quot;git-hooks-helper&quot;,
 &quot;odor&quot;,
 &quot;rake_check&quot;,
 &quot;koality&quot;,
 &quot;danmayer-metric_fu&quot;,
 &quot;bf4-metric_fu&quot;,
 &quot;metrics_satellite&quot;,
 &quot;code_hunter&quot;,
 &quot;kinit&quot;,
 &quot;rails-audit&quot;,
 &quot;pronto-rails_best_practices&quot;,
 &quot;free_disk_space&quot;,
 &quot;warder&quot;,
 &quot;ruby_osx_app&quot;,
 &quot;sanelint&quot;]
</code></pre>

<p>Out of curiosity I counted some wellknown gems usages by adding a <code>.count</code> at the end:</p>

<pre><code>rake:    23766
rails:   6283
thor:    2786
pry:     2870
sinatra: 1964
devise:  422 
</code></pre>

            </div>
          </section>
        
          <h1 class="content-subhead">
  2014-05-22
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/faria-devtips">faria devtips</a>
    
    
      <a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a><a class="post-tags post-tags-console" href="http://log.mose.com/tags/console">console</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2014/05/22/hackpad-cli" class="post-title">Hackpad cli</a>
            </header>

            <div class="post-description">
              <p>In Faria we use hackpad a lot, it&rsquo;s pretty useful. Mose made a command line interface so he can download all the pads locally and grep them all in one go. It also transforms the markdown much better than the original hackpad markdown export, which totally sucks (as for now). So pads can be recycled easily in github wiki pages.</p>

<ul>
<li><a href="https://github.com/mose/hackpad-cli">https://github.com/mose/hackpad-cli</a></li>
</ul>

            </div>
          </section>
        
          <h1 class="content-subhead">
  2013-02-10
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/old-tumblr-site">old tumblr site</a>
    
    
      <a class="post-tags post-tags-podcast" href="http://log.mose.com/tags/podcast">podcast</a><a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2013/02/10/geeky-podcasts" class="post-title">Geeky podcasts</a>
            </header>

            <div class="post-description">
              <p>Sometimes when doing some mechanical operation on my home workstation, involving repetitive action or something requiring low level of attention (like sorting mails, lurking on irc, updating a distro, â€¦), I like to put the headset and listen to stuff. But I never had any taste for music, I prefer listening to people that talk about some interesting topic.</p>

<p>I began this when starting working with rails, because that was a great flow of information, that had various sources:</p>

<ul>
<li><a href="http://rubyrogues.com">http://rubyrogues.com</a></li>
<li><a href="http://rubyshow.com">http://rubyshow.com</a></li>
<li><a href="http://learn.thoughtbot.com/podcast">http://learn.thoughtbot.com/podcast</a></li>
<li><a href="http://ruby5.envylabs.com">http://ruby5.envylabs.com</a></li>
</ul>

<p>All was good and then I checked out podcast clients for my environment (linux with ubuntu) and I found out <a href="http://gpodder.net">http://gpodder.net</a> which is exactly the kind of software I like. I does not much but what it does is well done. The website is a nice optional addition, only focused on podcasts and has a nice simple design and is free.</p>

<pre><code>apt-get install gpodder
</code></pre>

<p>Then I discovered a few other podcasts for hackers, or oriented towards science and knowledge. And I removed the rss feed I had in my thunderbird for listening to some French-speaking radio shows (like la-bas si j&rsquo;y suis).</p>

<p>The website makes possible to publish your subscription list, here is my list of very geeky selection:</p>

<ul>
<li><a href="https://gpodder.net/user/mose/subscriptions">https://gpodder.net/user/mose/subscriptions</a></li>
</ul>

            </div>
          </section>
        
          <h1 class="content-subhead">
  2012-12-10
  <p class="post-meta">
    
    
      originaly posted on 
      <a class="post-origin" href="http://log.mose.com/origin/old-tumblr-site">old tumblr site</a>
    
    
      <a class="post-tags post-tags-ruby" href="http://log.mose.com/tags/ruby">ruby</a>
    
    
  </p>
</h1>

          <section class="post">
            <header class="post-header">

              <a href="http://log.mose.com/2012/12/10/rubyconf-2012" class="post-title">RubyConf 2012</a>
            </header>

            <div class="post-description">
              <div class="gallery" itemscope itemtype="http://schema.org/ImageGallery">




<figure class="figure" itemscope itemtype="http://schema.org/ImageObject"><a href="http://res.cloudinary.com/mosepix/image/upload/rubyconf-2012/1-xenor" itemprop="contentUrl" data-size="1280x800"><img src="http://res.cloudinary.com/mosepix/image/upload/c_limit,h_100,w_150/c_thumb,g_center,h_100,w_150/rubyconf-2012/1-xenor" itemprop="thumbnail" alt="Xenor" /></a></figure>




<figure class="figure" itemscope itemtype="http://schema.org/ImageObject"><a href="http://res.cloudinary.com/mosepix/image/upload/rubyconf-2012/2-talk" itemprop="contentUrl" data-size="800x1280"><img src="http://res.cloudinary.com/mosepix/image/upload/c_limit,h_100,w_150/c_thumb,g_center,h_100,w_150/rubyconf-2012/2-talk" itemprop="thumbnail" alt="Talks" /></a></figure>




<figure class="figure" itemscope itemtype="http://schema.org/ImageObject"><a href="http://res.cloudinary.com/mosepix/image/upload/rubyconf-2012/3-restau" itemprop="contentUrl" data-size="1280x800"><img src="http://res.cloudinary.com/mosepix/image/upload/c_limit,h_100,w_150/c_thumb,g_center,h_100,w_150/rubyconf-2012/3-restau" itemprop="thumbnail" alt="At restaurant" /></a></figure>




<figure class="figure" itemscope itemtype="http://schema.org/ImageObject"><a href="http://res.cloudinary.com/mosepix/image/upload/rubyconf-2012/4-benxenor" itemprop="contentUrl" data-size="1280x800"><img src="http://res.cloudinary.com/mosepix/image/upload/c_limit,h_100,w_150/c_thumb,g_center,h_100,w_150/rubyconf-2012/4-benxenor" itemprop="thumbnail" alt="Xenor and benjamin" /></a></figure>




<figure class="figure" itemscope itemtype="http://schema.org/ImageObject"><a href="http://res.cloudinary.com/mosepix/image/upload/rubyconf-2012/5-conf" itemprop="contentUrl" data-size="1280x800"><img src="http://res.cloudinary.com/mosepix/image/upload/c_limit,h_100,w_150/c_thumb,g_center,h_100,w_150/rubyconf-2012/5-conf" itemprop="thumbnail" alt="Conference" /></a></figure>


</div>


<link rel="stylesheet" href="http://log.mose.com/css/photoswipe.css">
<link rel="stylesheet" href="http://log.mose.com/css/photoswipe-skin/default-skin.css">
<script src="http://log.mose.com/js/photoswipe.min.js"></script>
<script src="http://log.mose.com/js/photoswipe-ui-default.min.js"></script>
<script src="http://log.mose.com/js/initphotoswipe.js"></script>

<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <div class="pswp__counter"></div>
        <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
        <button class="pswp__button pswp__button--share" title="Share"></button>
        <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
        <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>
      <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
      </button>
      <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
      </button>
      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<script>
  initPhotoSwipeFromDOM('.gallery');
</script>


<p>Ruby Conf Taiwan 2012. Quite a great event.</p>

<p><a href="http://rubyconf.tw/2012/">http://rubyconf.tw/2012/</a></p>

            </div>
          </section>
        
      </div>
      

      <div class="footer">
  <div class="pure-menu pure-menu-horizontal pure-menu-open">
    <ul>
      <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
    </ul>
  </div>
</div>
<script src="http://log.mose.com/js/all.min.js"></script>

    </div>
  </div>
</div>


</body>
</html>
